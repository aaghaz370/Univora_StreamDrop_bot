<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Embed</title>
    <!-- Plyr CSS -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Red Theme Plyr */
        :root {
            --plyr-color-main: #ef4444;
            /* Red-500 */
        }

        .plyr {
            width: 100%;
            height: 100%;
        }

        /* Loading Spinner Overlay */
        /* Loading Spinner Overlay */
        #loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            /* Ensure above controls if needed, but below overlays */
            pointer-events: none;
            opacity: 1;
            transition: opacity 0.3s ease;
            background: rgba(0, 0, 0, 0.3);
            /* Optional: slight dimming */
        }

        .spinner {
            width: 8vmin;
            /* Responsive to viewport min dimension */
            height: 8vmin;
            min-width: 40px;
            min-height: 40px;
            max-width: 80px;
            max-height: 80px;
            border: 0.5vmin solid rgba(255, 255, 255, 0.1);
            border-top-color: #ef4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hidden {
            opacity: 0;
        }

        /* Double Tap Overlays */
        .dt-overlay {
            position: absolute;
            top: 50%;
            transform: translateY(-50%) scale(1);
            color: white;
            font-size: 2em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            opacity: 0;
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            pointer-events: none;
            z-index: 5;
        }

        .dt-overlay.left {
            left: 10%;
        }

        .dt-overlay.right {
            right: 10%;
        }
    </style>
</head>

<body>

    <!-- Double Tap Overlays -->
    <div id="dt-left" class="dt-overlay left">⏪ 10s</div>
    <div id="dt-right" class="dt-overlay right">10s ⏩</div>

    <video id="player" playsinline controls>
        <!-- Source added via JS -->
    </video>

    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script>
        const BASE_URL = window.location.origin;
        const FILE_ID = window.location.pathname.split("/").pop();
        const loader = document.getElementById("loader");

        async function init() {
            try {
                const res = await fetch(`${BASE_URL}/api/file/${FILE_ID}`);
                if (!res.ok) throw new Error("File not found");
                const data = await res.json();

                const playerEl = document.getElementById("player");
                playerEl.src = data.direct_dl_link;
                playerEl.type = data.mime_type || "video/mp4";

                // --- 1. Restore All Settings ---
                const player = new Plyr('#player', {
                    controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'],
                    settings: ['quality', 'speed', 'loop'],
                    speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
                    autoplay: false,
                    keyboard: { focused: true, global: true },
                    storage: { enabled: false, key: 'plyr' } // Disable storage to prevent SecurityError in iframes
                });

                // --- 3. Enhanced Keyboard Controls ---
                document.addEventListener('keydown', (e) => {
                    const key = e.code;
                    if (document.activeElement.tagName === 'INPUT') return; // Ignore if typing

                    switch (key) {
                        case 'Space':
                        case 'k':
                            e.preventDefault();
                            player.togglePlay();
                            break;
                        case 'KeyF':
                            e.preventDefault();
                            player.toggleFullscreen();
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            player.forward(5);
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            player.rewind(5);
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            player.increaseVolume(0.1);
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            player.decreaseVolume(0.1);
                            break;
                    }
                });

                // --- 4. Mobile Double Tap to Seek ---
                let lastTap = 0;
                const doubleTapDelay = 300;
                const wrapper = document.querySelector('.plyr'); // Plyr wrapper

                wrapper.addEventListener('touchend', (e) => {
                    const currentTime = new Date().getTime();
                    const tapLength = currentTime - lastTap;
                    lastTap = currentTime;

                    if (tapLength < doubleTapDelay && tapLength > 0) {
                        e.preventDefault();
                        const rect = wrapper.getBoundingClientRect();
                        const x = e.changedTouches[0].clientX - rect.left; // x position within player
                        const width = rect.width;

                        // Check zone
                        if (x < width * 0.4) {
                            // Left Side -> Rewind
                            player.rewind(10);
                            showFeedback('left');
                        } else if (x > width * 0.6) {
                            // Right Side -> Forward
                            player.forward(10);
                            showFeedback('right');
                        }
                    }
                });

                function showFeedback(side) {
                    const id = side === 'left' ? 'dt-left' : 'dt-right';
                    const el = document.getElementById(id);
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(-50%) scale(1.5)'; /* Adjusted for vertical centering */
                    setTimeout(() => {
                        el.style.opacity = '0';
                        el.style.transform = 'translateY(-50%) scale(1)'; /* Adjusted for vertical centering */
                    }, 500);
                }

            } catch (e) {
                console.error(e);
                document.body.innerHTML = `<div style="color:white; text-align:center; font-family:sans-serif;">Video Unavailable</div>`;
            }
        }

        init();
    </script>
</body>

</html>